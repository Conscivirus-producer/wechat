<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>上传课堂记录</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
<!-- Loading Bootstrap -->
<link href="<?php echo "http://".$_SERVER ['HTTP_HOST'] ?>/css/vendor/bootstrap.min.css" rel="stylesheet">
<!-- Loading Flat UI -->
<link href="<?php echo "http://".$_SERVER ['HTTP_HOST'] ?>/css/flat-ui.min.css" rel="stylesheet">
<link href="<?php echo "http://".$_SERVER ['HTTP_HOST'] ?>/timepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
<script src="<?php echo "http://".$_SERVER ['HTTP_HOST'] ?>/js/vendor/jquery.min.js"></script>
<!-- HTML5 shim, for IE6-8 support of HTML5 elements. All other JS at the end of file. -->
<!--[if lt IE 9]>
<script src="http://localhost/wechat/js/vendor/html5shiv.js"></script>
<script src="http://localhost/wechat/js/vendor/respond.min.js"></script>
<![endif]-->
<style>
*{
	font-size:15px;
}
.sl-custom-file{
	display:inline-block;
	text-align:center;
	overflow:hidden;
	position:relative;
}
.ui-input-file{
	opacity:0;
	filter:alpha(opacity=0);
	position:absolute;
	top:0;
	right:0;
}
</style>
</head>
<body>
<input type="text" name="recordId" id="recordId" value="{$recordId}" style="display:none">
<input type="text" name="teachingDt" id="teachingDt" value="{$teachingDt}" style="display:none">
<input type="text" name="token" id="token" value="{$token}" style="display:none">
<input type="text" name="transactionId" id="transactionId" value="{$transactionId}" style="display:none">
<input type="text" name="status" id="status" value="{$status}" style="display:none">
<div class="container">
	<div class="row">
		<div class="col-md-4 col-md-offset-4">
			<h5 class="text-center"><font color="#48C9B0">课堂记录</font></h5>
		</div>
	</div>
	
	<volist name="assessmentSettings" id="as">
	<div class="row" style="margin-top:15px">
		<div class="col-md-4 col-md-offset-4 assessment" name="{$as.code}">
			<p class="text-center" style="font-size:15px">{$as.code}，{$as.description}</p>
			<div class="btn-group btn-group-justified" role="group">
  				<div class="btn-group" role="group">
    				<input type="button" class="btn btn-default" value="一般" name="1">
  				</div>
  				<div class="btn-group" role="group" style="border-left:1px solid #fff;border-right:1px solid #fff">
    				<input type="button" class="btn btn-default" value="好" name="2">
  				</div>
 				<div class="btn-group" role="group">
    				<input type="button" class="btn btn-default" value="优秀" name="3">
  				</div>
			</div>
		</div>
	</div>
	</volist>
	
	<div class="row" style="margin-top:15px">
		<div class="col-md-4 col-md-offset-4">
			<div class="form-group">
    			<label for="teachingtime">教学时间：</label>
    			<input type="text" value="{$teachingDt}" class="form-control" id="teachingtime" data-date-format="yyyy-mm-dd" readonly>
  			</div>
		</div>
	</div>
	<div class="row" style="margin-top:15px">
		<div class="col-md-4 col-md-offset-4">
			<textarea class="form-control" rows="3" placeholder="老师评语" id="comment"></textarea>
		</div>
	</div>
	<div class="row" style="margin-top:15px">
		<div class="col-md-4 col-md-offset-4">
			<span class="sl-custom-file">
    			<button type="button" class="btn btn-primary">
  					添加教学图片<span class="fui-document"></span>
  				<span class="fui-plus"></span>
				</button>
   			 	<input type="file" class="ui-input-file" name="teachingPicture" id="teachingPicture"/>
			</span>
		</div>
	</div>
	<div class="row">
		<div class="col-md-4 col-md-offset-4" id="teachingPictureGallery">
			
		</div>
	</div>
	<div class="row" style="margin-top:15px">
		<div class="col-md-4 col-md-offset-4">
			<div class="btn-group btn-group-justified" role="group" id="overallScore">
  				<div class="btn-group" role="group">
    				<button type="button" class="btn btn-default" name="1"><span class="fui-star-2"></span></button>
  				</div>
  				<div class="btn-group" role="group" style="border-left:1px solid #fff;border-right:1px solid #fff">
    				<button type="button" class="btn btn-default" name="2"><span class="fui-star-2"></span></button>
  				</div>
 				<div class="btn-group" role="group">
    				<button type="button" class="btn btn-default" name="3"><span class="fui-star-2"></span></button>
  				</div>
  				<div class="btn-group" role="group" style="border-left:1px solid #fff;border-right:1px solid #fff">
    				<button type="button" class="btn btn-default" name="4"><span class="fui-star-2"></span></button>
  				</div>
  				<div class="btn-group" role="group">
    				<button type="button" class="btn btn-default" name="5"><span class="fui-star-2"></span></button>
  				</div>
			</div>
		</div>
	</div>
	<div class="row" style="margin-top:15px; margin-bottom:25px">
		<div class="col-md-4 col-md-offset-4">
			<button type="button" class="btn btn-primary btn-block" id="submit" name="submit">提交</button>
		</div>
	</div>
</div>
</body>
<script src="<?php echo "http://".$_SERVER ['HTTP_HOST'] ?>/js/flat-ui.min.js"></script>
<script src="<?php echo "http://".$_SERVER ['HTTP_HOST'] ?>/assets/js/application.js"></script>
<script type="text/javascript" src="<?php echo "http://".$_SERVER ['HTTP_HOST'] ?>/timepicker/js/bootstrap-datetimepicker.js" charset="UTF-8"></script>
<script type="text/javascript" src="<?php echo "http://".$_SERVER ['HTTP_HOST'] ?>/timepicker/js/locales/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>
<script type="text/javascript">
var transactionId = "";
var recordId = "";   				
var teachingDt = "";				
var overallScore = "";				
var comment = "";
var teachingPictureTimeTag = "";
var assessCompleted;						//check whether assessment is completed
var assessScore;							//array to store the assessment score
var teachingImageArray = new Array();		//array to store the image keys
var postdata = {
	"recordId" : "",
	"assessmentScore" : "",
	"teachingDt" : "",
	"comment" : "",
	"teachingImage" : "",
	"overallScore" : ""
};
$(document).ready(function(){
	transactionId = $("#transactionId").val();
	
	recordId = $("#recordId").val();
	teachingDt = $("#teachingDt").val();
	$(".col-md-4.col-md-offset-4.assessment").each(function(){
		var assessmentDiv = $(this);
		assessmentDiv.find("input").click(function(){
			assessmentDiv.find("input").attr("class","btn btn-default");
			$(this).attr("class","btn btn-primary");
		});
	});
	
	$("#overallScore").find("button").click(function(){
		$("#overallScore").find("button").attr("class","btn btn-default");
		var name = parseInt($(this).attr("name"));
		for(var i = 1; i <= name; i++){
			$("#overallScore").find("button[name="+i+"]").attr("class","btn btn-primary");
		}
		overallScore = name;
	});
	
	$("#submit").click(function(){
		assessCompleted = true;
		assessScore = new Array();
		$(".col-md-4.col-md-offset-4.assessment").each(function(){
			var choosedInput = $(this).find("input[class='btn btn-primary']");
			if(choosedInput.length == 0){
				assessCompleted = false;
			}else{
				choosedInput.each(function(){
					assessScore.push($(this).attr("name"));
				});
			}
		});
		if(assessCompleted == true){
			comment = $("#comment").val();
			if(comment == ""){
				alert("请输入评论");
			}else if(overallScore == ""){
				alert("请为学生打分");
			}
			
			//所有选项都是正确的,就开始POST数据
			postdata.assessmentScore = assessScore.join(",");
			postdata.teachingDt = $("#teachingtime").val();
			postdata.comment = comment;
			postdata.teachingImage = teachingImageArray.join(",");
			postdata.overallScore = overallScore;
			postdata.recordId = recordId;
			
			$.post("supporting.php", postdata,
   				function(data){
     				alert("课堂记录上传成功！");
     				window.location.href = "http://www.ilearnnn.com/thinkphp/Wechat/TeacherRecord/teachingRecord.html?transactionId="+transactionId;
     			}
   			);
		}else{
			//有测试老师没选择
			alert("请为学生的测试打分");
		}
	});
	$('#teachingtime').datetimepicker({
        language:  'zh-CN',
        weekStart: 1,
        todayBtn:  1,
		autoclose: 1,
		todayHighlight: 1,
		startView: 2,
		minView: 2,
		forceParse: 0
    });
    
    var Qiniu_UploadUrl = "http://up.qiniu.com";
    $("#teachingPicture").change(function() {
        //普通上传
        var Qiniu_upload = function(f, token, key) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', Qiniu_UploadUrl, true);
            var formData, startDate;
            formData = new FormData();
            if (key !== null && key !== undefined) formData.append('key', key);
            formData.append('token', token);
            formData.append('file', f);
            var taking;

            xhr.onreadystatechange = function(response) {
                if (xhr.readyState == 4 && xhr.status == 200 && xhr.responseText != "") {
                    var blkRet = JSON.parse(xhr.responseText);
                    console && console.log(blkRet);
                  	$('img[name*="loading'+teachingPictureTimeTag+'"]').remove();
                  	$("#teachingPictureGallery").append(
						$("<img/>").attr("src", "http://7xk9ts.com2.z0.glb.qiniucdn.com/"+"recordId_"+recordId+"_teachingDt_"+teachingDt+"_"+teachingPictureTimeTag+"?imageView2/1/w/500/h/500/q/100").attr("class", "img-responsive img-rounded").attr("width", "50%")
					);
					teachingImageArray.push("recordId_"+recordId+"_teachingDt_"+teachingDt+"_"+teachingPictureTimeTag);
                } else if (xhr.status != 200 && xhr.responseText) {
					alert("上传教学图片失败");
					$('img[name*="loading'+teachingPictureTimeTag+'"]').remove();
                }
            };
            startDate = new Date().getTime();
            xhr.send(formData);
        };
        var token = $("#token").val();
        if ($("#teachingPicture")[0].files.length > 0 && token != "") {
        	teachingPictureTimeTag = new Date().getTime();
        	$("#teachingPictureGallery").append($("<br/>"));
        	$("#teachingPictureGallery").append(
				$("<img />").attr("src", "http://www.ilearnnn.com/image/loading_normal.gif").attr("class", "img-responsive").attr("style", "margin: 0 auto").attr("name", "loading"+teachingPictureTimeTag)
			);
            Qiniu_upload($("#teachingPicture")[0].files[0], token, "recordId_"+recordId+"_teachingDt_"+teachingDt+"_"+teachingPictureTimeTag);
        } else {
            console && console.log("form input error");
        }
    });
});
</script>
</html>










